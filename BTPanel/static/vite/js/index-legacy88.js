System.register(["./page_layout-legacy.js?v=1741416570306","./campaign-legacy.js?v=1741416570306","./vue-legacy.js?v=1741416570306","./public-legacy.js?v=1741416570306","./naive-legacy.js?v=1741416570306","./index.vue_vue_type_script_setup_true_lang-legacy3.js?v=1741416570306","./common-legacy.js?v=1741416570306","./__commonjsHelpers__-legacy.js?v=1741416570306","./mail-legacy.js?v=1741416570306"],(function(e,t){"use strict";var a,l,n,o,i,r,s,d,u,c,p,f,v,b,y,m,g,_,k,h,x,w,K,N,j,C,E,U,z,S,D,R,$,P,A,I,W,T,L,G,V,O,F,q,B,H,M,Y,Q,X,J,Z,ee,te,ae,le,ne;return{setters:[e=>{a=e.b,l=e.m,n=e.g,o=e._,i=e.k,r=e.E,s=e.F,d=e.G,u=e.l,c=e.H,p=e.I},e=>{f=e.g,v=e.e,b=e.a,y=e.b,m=e.c},e=>{g=e.r,_=e.N,k=e.c,h=e.F,x=e.a7,w=e.d,K=e.ap,N=e.e,j=e.P,C=e._,E=e.$,U=e.R,z=e.Q,S=e.L,D=e.a0,R=e.S,$=e.ao,P=e.a3,A=e.an,I=e.af,W=e.a1,T=e.j,L=e.k,G=e.v,V=e.X,O=e.ah,F=e.G},e=>{q=e.a},e=>{B=e.cf,H=e.cg,M=e.bR,Y=e.bG,Q=e.bT,X=e.ch,J=e.cb,Z=e._,ee=e.ci,te=e.bV,ae=e.bS,le=e.T},e=>{ne=e._},null,null,null],execute:function(){var t=document.createElement("style");t.textContent=".tool-icon[data-v-4e70f650]{width:18px;height:18px;border:1px dashed #bababa;background-color:#f9f9f9;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s}.tool-icon[data-v-4e70f650]:hover{width:40px;border-color:#20a53a}.add-node[data-v-4e70f650]{max-width:510px;box-sizing:border-box;padding:10px;background:#fff}.add-node .header[data-v-4e70f650]{text-align:center;font-weight:700;font-size:16px}.add-node .node-list[data-v-4e70f650]{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-start;margin-top:20px}.add-node .node-list .node-item[data-v-4e70f650]{width:90px;height:90px;background:#f3f4f6;display:flex;justify-content:center;align-items:center;font-size:14px;font-weight:700;cursor:pointer}.email-box[data-v-9bb21c05]{display:flex;align-items:center;justify-content:center;width:100%;height:176px;background-color:#fafafa;border-top-left-radius:6px;border-top-right-radius:6px}.normal-node[data-v-c03efef8]{padding:24px 32px;text-align:center;font-size:14px}.line[data-v-0b2e1f55]{width:1px;height:24px;background-color:#d1d5db}.tools-box[data-v-0b2e1f55]{display:flex;flex-direction:column;align-items:center}.node-box[data-v-0b2e1f55]{position:relative;width:256px;min-height:50px;border:1px solid rgba(209,213,219,.5);background-color:#fff;border-radius:6px;transition:all .3s;cursor:pointer}.node-box[data-v-0b2e1f55]:hover{border-color:#d1d5db}.node-box .node-title[data-v-0b2e1f55]{position:absolute;top:8px;left:8px;display:flex;align-items:center;justify-content:center;gap:6px}.node-box .node-title .icon[data-v-0b2e1f55]{font-size:16px}.node-box .node-title .text[data-v-0b2e1f55]{font-size:12px;color:#999}.node-box .del-node[data-v-0b2e1f55]{position:absolute;right:8px;top:8px;font-size:14px}.node-box.warning[data-v-0b2e1f55]{border-color:rgba(253,202,98,.7)}.node-box.warning[data-v-0b2e1f55]:hover{border-color:#fdca62;box-shadow:0 0 1px 3px rgba(253,202,98,.2)}.node-box.action[data-v-0b2e1f55],.node-box.action[data-v-0b2e1f55]:hover{border-color:#20a53a;box-shadow:0 0 1px 3px rgba(32,165,58,.2)}.line[data-v-fbf5dbc0]{width:1px;height:24px;background-color:#d1d5db}.tools-box[data-v-fbf5dbc0]{display:flex;flex-direction:column;align-items:center}.node-box[data-v-fbf5dbc0]{position:relative;width:256px;padding:24px 32px;border:1px solid rgba(209,213,219,.5);background-color:#fff;border-radius:6px;transition:all .3s;cursor:pointer}.node-box[data-v-fbf5dbc0]:hover{border-color:#d1d5db}.node-box .node-title[data-v-fbf5dbc0]{position:absolute;top:8px;left:8px;display:flex;align-items:center;justify-content:center;gap:6px}.node-box .node-title .icon[data-v-fbf5dbc0]{font-size:16px}.node-box .node-title .text[data-v-fbf5dbc0]{font-size:12px;color:#999}.node-box .del-node[data-v-fbf5dbc0]{position:absolute;right:8px;top:8px;font-size:14px}.node-box.warning[data-v-fbf5dbc0]{border-color:rgba(253,202,98,.7)}.node-box.warning[data-v-fbf5dbc0]:hover{border-color:#fdca62;box-shadow:0 0 1px 3px rgba(253,202,98,.2)}.node-box.warning .node-title .icon[data-v-fbf5dbc0]{color:#fdca62}.node-box.action[data-v-fbf5dbc0],.node-box.action[data-v-fbf5dbc0]:hover{border-color:#20a53a;box-shadow:0 0 1px 3px rgba(32,165,58,.2)}.condition-box[data-v-fbf5dbc0]{display:flex}.condition-box .condition-item[data-v-fbf5dbc0]{position:relative;display:flex;flex-direction:column;align-items:center;min-width:288px}.horizontal-line[data-v-fbf5dbc0]{position:absolute;top:0;right:0;width:50%;height:1px;background-color:#d1d5db}.horizontal-line.left[data-v-fbf5dbc0]{left:0}.horizontal-line.right[data-v-fbf5dbc0]{right:0}.flow-tree[data-v-fbf5dbc0],.flow-tree li[data-v-fbf5dbc0]{display:flex;flex-direction:column;align-items:center}.condition-state[data-v-fbf5dbc0]{display:flex;align-items:center;justify-content:center;width:48px;height:32px;border-radius:4px;color:#fff}.condition-state.success[data-v-fbf5dbc0]{background-color:#20a53a}.condition-state.fail[data-v-fbf5dbc0]{background-color:#ef0808}.flow-container[data-v-459fbb31]{flex:1;position:relative;width:100%;height:100%;padding:32px;background-color:#f3f4f6;overflow:auto}.flow-container .flow-tree[data-v-459fbb31],.flow-container .flow-tree li[data-v-459fbb31]{display:flex;flex-direction:column;align-items:center}.test-box[data-v-459fbb31]{width:300px;height:60px;background:#f30}.condition-box[data-v-c8dfd4ad]{margin-top:12px;padding:12px;border:1px solid #d9d9d9;border-radius:4px}.flow-config[data-v-b1d9958a]{display:flex;flex-direction:column;width:380px;height:100%;border-left:1px solid #e5e7eb;overflow:hidden}.config-title[data-v-b1d9958a]{padding-top:16px;padding-bottom:16px;text-align:center;line-height:20px;border-bottom:1px solid #e5e7eb}.config-footer[data-v-b1d9958a]{display:flex;justify-content:flex-end;padding:16px 20px;border-top:1px solid #e5e7eb}.mail-flow[data-v-b7d1832f]{display:flex;flex-direction:column;width:100%;height:100%}\n",document.head.appendChild(t);const oe=g(0),ie=g([]),re=g([]),se=g(Date.now()),de=g("root"),ue=g("trigger"),ce=g({root:{nodeKey:"root",parentNodeKey:"",type:"trigger",id:0,parent_id:0,broken:!1,complete:!0,config:{type:"subscriber_added",group_ids:[]}}}),pe=g({}),fe=g({}),ve=g({}),be=g({}),ye=g({}),me=g({}),ge=g({trigger:ce,email:pe,delay:fe,webhook:ve,action:be,abTest:ye,condition:me}),_e=g({nodeKey:"",parentNodeKey:"",type:"trigger",next:null,id:0,parent_id:0,broken:!1,complete:!1}),ke=g({..._e.value,config:{type:"subscriber_added",group_ids:[]}}),he=g({..._e.value,email_id:0,name:"",subject:"",from:"",from_name:"",track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),xe=g({..._e.value,value:0,unit:"days",description:""}),we=g({..._e.value,url:"",secret:""}),Ke=g({..._e.value,action:"add_to_subscribers",group_ids:[],description:""}),Ne=g({..._e.value,name:"",branches:[]}),je=g({..._e.value,rules:[{type:null}],logic_type:"or",yes:[],no:[],description:""}),Ce=g({trigger:ke,email:he,delay:xe,webhook:we,action:Ke,abTest:Ne,condition:je}),Ee={events:{},$on(e,t){this.events[e]?this.events[e].push(t):this.events[e]=[t]},$emit(e,t){this.events[e].forEach((e=>{e(t)}))},$unsubscribe(e){this.events[e]=[]}};function Ue(e,t){const a="trigger"===e?"root":n(),l=M(Ce.value[e]);return l.nodeKey=a,l.parentNodeKey=t,l.type=e,ge.value[e][a]=l,l}function ze(e,t){const a=Ue(e,t);return me.value[t].no.unshift({type:e,key:a.nodeKey}),"condition"==e&&Ee.$on(a.nodeKey,(()=>{!function(e,t){const a=me.value[t].no.findIndex((t=>t.key==e));me.value[t].no.splice(a,1),Ee.$unsubscribe(e)}(a.nodeKey,t)})),a}function Se(e,t){const a=me.value[e],{parentNodeKey:l}=a;a[t].forEach((t=>{if("trigger"!==t.type&&(ge.value[t.type][t.key].parentNodeKey=a.parentNodeKey),"root"===l)re.value.push({type:t.type,key:t.key});else{const a=me.value[l],n=function(e){const t=me.value[e],a=t.parentNodeKey,l=me.value[a];return l.yes.some((t=>t.key===e))?"yes":"no"}(e);a[n].push({type:t.type,key:t.key})}}))}function De(e,t){const a=re.value.findIndex((e=>e.key==t));re.value.splice(a,1),delete ge.value[e][t]}function Re(e){const t=g(1),a=ge.value.condition[e],l=a.yes.length>0||a.no.length>0;q({title:"Please choose one of the following",width:400,content:()=>_(h,null,[l&&_(B,{value:t.value,onUpdateValue:e=>t.value=e},{default:()=>[_("div",null,[_(H,{value:1},{default:()=>[k("Delete both branches including all steps below.")]})]),_("div",{class:"mt-6px"},[_(H,{value:2},{default:()=>[k("Delete only YES branch including steps below.")]})]),_("div",{class:"mt-6px"},[_(H,{value:3},{default:()=>[k("Delete only NO branch including steps below.")]})])]}),!l&&_("div",null,[k("Do you really want to delete this step?")])]),onConfirm:async()=>{switch(t.value){case 1:$e(e),Pe(e),Ae(e);break;case 2:$e(e),Se(e,"no"),Ae(e);break;case 3:Pe(e),Se(e,"yes"),Ae(e)}await qe(),de.value===e&&(se.value=Date.now(),de.value="root",ue.value="trigger")}})}function $e(e){me.value[e].yes.forEach((t=>{var a;"trigger"!==t.type&&("condition"!==t.type?Ie(t.type,e,t.key):($e(a=t.key),Ee.$emit(a)))}))}function Pe(e){me.value[e].no.forEach((t=>{var a;"trigger"!==t.type&&("condition"!==t.type?We(t.type,e,t.key):(Pe(a=t.key),Ee.$emit(a)))}))}function Ae(e){const t=me.value[e],{parentNodeKey:a}=t;if("root"===a)De("condition",e);else{const t=me.value[a];let l=t.yes.findIndex((t=>t.key===e));l>-1?t.yes.splice(l,1):(l=t.no.findIndex((t=>t.key===e)),t.no.splice(l,1))}}function Ie(e,t,a){const l=me.value[t].yes.findIndex((e=>e.key==a));me.value[t].yes.splice(l,1),delete ge.value[e][a]}function We(e,t,a){const l=me.value[t].no.findIndex((e=>e.key==a));me.value[t].no.splice(l,1),delete ge.value[e][a]}function Te(e,t){const a=me.value[t].yes.findIndex((t=>t.key==e));me.value[t].yes.splice(a,1),Ee.$unsubscribe(e)}function Le(e){Be();const{root:t,triggers:a}=e;Y(a)&&a.length>0&&("subscriber_added"===a[0].type&&(ge.value.trigger.root.complete=a[0].group_ids.length>0),ge.value.trigger.root.config=a[0]),re.value=Ge(t,"root")}function Ge(e,t,a=!1){const l=[];let n=e;for(;n;){const e=n.nodeKey,i={key:e,type:n.type};if(l.push(i),"condition"===n.type){a&&Ee.$on(e,(()=>{Te(e,t)})),ge.value.condition[e]=Ve(n,e);break}ge.value[n.type][e]=(o=n,{...o,next:null}),n=n.next}var o;return l}function Ve(e,t){return{...e,nodeKey:t,yes:Ge(e.yes,t,!0),no:Ge(e.no,t,!0),next:null}}function Oe(e){return e.reduceRight(((e,t)=>{const a=ge.value[t.type][t.key],l=M(a);return"condition"===l.type?{...(n=l,{...n,yes:Oe(n.yes),no:Oe(n.no),next:null}),next:e}:{...l,next:e};var n}),null)}async function Fe(){const{message:e}=await f({id:oe.value});a(e)&&Le(e)}async function qe(e="save"){const t=function(){const e=Oe(re.value);return{triggers:[x(ge.value.trigger.root.config)],root:e}}(),{message:n}=await v({id:oe.value,...t});if(a(n)){switch(e){case"save":l.success("Save successfully");break;case"del":l.success("Node deleted successfully");break;case"add":l.success("Node added successfully")}Le(n)}}async function Be(){re.value=[],Object.keys(ge.value).forEach((e=>{"trigger"!==e&&(ge.value[e]={})}))}function He(){se.value=Date.now(),de.value="root",ue.value="trigger"}const Me={class:"tool-icon"},Ye={class:"add-node"},Qe={class:"node-list"},Xe=["onClick"],Je=w({__name:"ToolAdd",props:{parentKey:{},parentType:{},last:{type:Boolean}},emits:["addNode"],setup(e,{emit:t}){const a=e,l=t,n=K("popoverRef"),i=g([{type:"email",icon:"",desc:"Email"},{type:"delay",icon:"",desc:"Delay"},{type:"webhook",icon:"",desc:"Webhook"}]),r=N((()=>a.last?i.value:i.value.filter((e=>"condition"!==e.type))));return(e,t)=>{const i=o,s=Q;return j(),C(s,{ref_key:"popoverRef",ref:n,trigger:"click"},{trigger:E((()=>[U("div",Me,[_(i,{name:"base-add",size:"16"})])])),default:E((()=>[U("div",Ye,[t[0]||(t[0]=U("div",{class:"header"},"Add a next step to your workflow",-1)),U("div",Qe,[(j(!0),z(h,null,S(R(r),(e=>(j(),z("div",{key:e.type,class:"node-item",onClick:t=>{return o=e.type,l("addNode",o,a.parentKey),void n.value?.setShow(!1);var o}},D(e.desc),9,Xe)))),128))])])])),_:1},512)}}}),Ze=i(Je,[["__scopeId","data-v-4e70f650"]]),et={class:"normal-node"},tt={key:0,class:"font-bold"},at=w({__name:"TriggerNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>ce.value[t.nodeKey])),l=N((()=>{const{config:e}=a.value;if("subscriber_added"===e.type&&0===e.group_ids.length)return"Set up workflow trigger";switch(e.type){case"subscriber_added":return"When a new email joins group(s) ";case"subscribed":return"When subscriber joins group(s) ";case"opened":return"When subscriber opens an email ";case"clicked":return`When subscriber clicks a link ${e.link} `;case"unsubscribed":return"When subscriber unsubscribes ";default:return"Set up workflow trigger "}})),n=N((()=>{const{config:e}=a.value;switch(e.type){case"subscriber_added":case"subscribed":return o(e.group_ids);case"clicked":return e.link.url}return""})),o=e=>ie.value.filter((t=>e.includes(t.id))).map((e=>e.mail_type)).join(", ");return(e,t)=>(j(),z("div",et,[U("span",null,D(R(l)),1),R(n)?(j(),z("span",tt,D(R(n)),1)):$("",!0)]))}}),lt={class:"normal-node"},nt={class:"mt-8px"},ot={key:0,class:"font-bold"},it=w({__name:"ActionNode",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>be.value[t.nodeKey])),l=N((()=>{if(a.value.complete&&a.value.group_ids.length>0)switch(a.value.action){case"add_to_subscribers":return"Add to group(s) ";case"remove_from_subscribers":return"Remove from group(s) ";case"mark_as_unsubscribe":return"Mark as unsubscribed"}return"Define action"})),n=N((()=>{if(a.value.complete)switch(a.value.action){case"add_to_subscribers":case"remove_from_subscribers":return i(a.value.group_ids)}return""})),i=e=>ie.value.filter((t=>e.includes(t.id))).map((e=>e.mail_type)).join(", ");return(e,t)=>{const a=o;return j(),z("div",lt,[U("div",null,[_(a,{name:"flow-action",size:"16"})]),U("div",nt,[U("span",null,D(R(l)),1),R(n)?(j(),z("span",ot,D(R(n)),1)):$("",!0)])])}}}),rt={class:"normal-node"},st={class:"mt-8px"},dt=w({__name:"DelayNode",props:{type:{default:"delay"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>fe.value[t.nodeKey])),l=N((()=>a.value.complete?`Wait ${a.value.value} ${a.value.unit}`:"Set delay"));return(e,t)=>{const a=o;return j(),z("div",rt,[U("div",null,[_(a,{name:"flow-delay",size:"16"})]),U("div",st,D(R(l)),1)])}}}),ut={class:"normal-node"},ct={class:"mt-8px"},pt=i(w({__name:"EmailNode",props:{type:{default:"email"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>pe.value[t.nodeKey])),l=N((()=>a.value.complete?a.value.name:"Set email"));return(e,t)=>{const a=o;return j(),z("div",ut,[U("div",null,[_(a,{name:"flow-email",size:"16"})]),U("div",ct,D(R(l)),1)])}}}),[["__scopeId","data-v-9bb21c05"]]),ft={class:"normal-node"},vt={class:"mt-8px"},bt=w({__name:"WebhookNode",props:{type:{default:"webhook"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>ve.value[t.nodeKey])),l=N((()=>a.value.complete?a.value.url:"Set webhook"));return(e,t)=>{const a=o;return j(),z("div",ft,[U("div",null,[_(a,{name:"flow-webhook",size:"16"})]),U("div",vt,D(R(l)),1)])}}}),yt=i({},[["render",function(e,t){return j(),z("div")}]]),mt=i(w({__name:"index",props:{type:{default:"trigger"},nodeKey:{default:""}},setup(e){const t=e,a=N((()=>{switch(t.type){case"trigger":return at;case"delay":return dt;case"action":return it;case"email":return pt;case"webhook":return bt;default:return yt}}));return(e,t)=>(j(),C(P(R(a)),{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"]))}}),[["__scopeId","data-v-c03efef8"]]),gt={key:0,class:"line"},_t={class:"node-title"},kt={key:1,class:"text"},ht={class:"tools-box"},xt=w({__name:"NormalNode",props:{last:{type:Boolean,default:!1},type:{default:"trigger"},nodeKey:{default:"root"}},emits:["addNode","delNormalNode","selectNode"],setup(e,{emit:t}){const a=e,n=t,i=N((()=>"trigger"!==a.type)),s=N((()=>!u.value.complete)),d=N((()=>a.nodeKey===de.value)),u=N((()=>ge.value[a.type][a.nodeKey])),c=N((()=>a.type?r(a.type):""));function p(){n("selectNode",a.type,a.nodeKey)}function f(e){n("addNode",e,u.value)}function v(){if("email"===a.type){let e=!1;const t=ge.value.email[a.nodeKey],n=ge.value.condition,o=Object.entries(n);for(const[,a]of o){if(a.complete&&a.rules.length>0)for(const l of a.rules)if("workflow"===l.type&&l.node_id===t.id){e=!0;break}if(e)break}if(e)return void l.error("The email node is used in the condition node and cannot be deleted",{close:!0})}q({title:"Please confirm",content:"Do you really want to delete this step?",onConfirm:async()=>{n("delNormalNode",a.type,a.nodeKey),await qe("del")}})}return(e,t)=>{const a=o;return j(),z(h,null,[R(i)?(j(),z("div",gt)):$("",!0),U("div",{class:I(["node-box",{warning:R(s),action:R(d)}]),onClick:p},[U("div",_t,[R(s)?(j(),C(a,{key:0,class:"icon",name:"warning",color:"#FDCA62"})):$("",!0),R(i)?(j(),z("span",kt,D(R(c)),1)):$("",!0)]),R(i)?(j(),z("span",{key:0,class:"del-node",onClick:A(v,["stop"])},[_(a,{name:"flow-del"})])):$("",!0),_(mt,{type:e.type,"node-key":e.nodeKey},null,8,["type","node-key"])],2),U("div",ht,[t[0]||(t[0]=U("div",{class:"line"},null,-1)),U("div",null,[_(Ze,{last:e.last,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:f},null,8,["last","parent-type","parent-key"])])])],64)}}}),wt=i(xt,[["__scopeId","data-v-0b2e1f55"]]),Kt={class:"node-title"},Nt={class:"text-center"},jt={class:"mt-12px text-14px text-center"},Ct={key:0,class:"font-bold"},Et={class:"tools-box"},Ut={class:"condition-box"},zt={class:"condition-item"},St={class:"condition-state success"},Dt={class:"tools-box"},Rt={key:0,class:"flow-tree"},$t={class:"condition-item"},Pt={class:"condition-state fail"},At={class:"tools-box"},It={key:0,class:"flow-tree"},Wt=w({name:"ConditionNode",__name:"ConditionNode",props:{type:{default:"trigger"},nodeKey:{default:"root"}},emits:["delCondition","selectNode"],setup(e,{emit:t}){const a=e,l=t,n=N((()=>!r.value.complete)),i=N((()=>a.nodeKey===de.value)),r=N((()=>me.value[a.nodeKey])),s=new Map([["clicked"," had any link clicked"],["link_clicked"," had a specific link clicked"],["link_not_clicked"," did not have a specific link clicked"],["opened"," was opened"],["not_opened"," was not opened"],["opened_with_not_clicked"," was opened with no links clicked"]]),d=N((()=>{const{rules:e}=r.value;if(e.length>0&&null!==e[0].type)switch(e[0].type){case"campaign":return e[0].campaign.name;case"workflow":return function(e,t){const a=ge.value[t],l=Object.entries(a).filter((([,t])=>t.id===e));return l.length>0?l[0][1].name:""}(e[0].node_id,"email")}return""})),u=N((()=>{const{complete:e,rules:t,logic_type:a}=r.value;if(e&&t.length>0&&null!==t[0].type){let e=s.get(t[0].action)||"";return t.length>1&&(e+=` ${a} +${t.length-1} condition`),e}return"Define condition"})),c=()=>{l("selectNode","condition",a.nodeKey)},p=(e,t)=>{l("selectNode",e,t)};async function f(e,t){const a=function(e,t){const a=Ue(e,t);return me.value[t].yes.unshift({type:e,key:a.nodeKey}),"condition"==e&&Ee.$on(a.nodeKey,(()=>{Te(a.nodeKey,t)})),a}(e,t);await qe("add"),p(a.type,a.nodeKey)}async function v(e){const t=function(e,t){const a=Ue(e,t);return me.value[t].yes.push({type:e,key:a.nodeKey}),a}(e,a.nodeKey);await qe("add"),p(t.type,t.nodeKey)}async function b(e,t){const a=ze(e,t);await qe("add"),p(a.type,a.nodeKey)}async function y(e){const t=function(e,t){const a=Ue(e,t);return me.value[t].no.push({type:e,key:a.nodeKey}),a}(e,a.nodeKey);await qe("add"),p(t.type,t.nodeKey)}function m(){l("delCondition",a.nodeKey)}function g(e){Re(e)}function k(e,t){Ie(e,a.nodeKey,t),de.value===t&&p("trigger","root")}function x(e,t){We(e,a.nodeKey,t),de.value===t&&p("trigger","root")}return(e,t)=>{const a=o,l=W("ConditionNode",!0);return j(),z(h,null,[t[8]||(t[8]=U("div",{class:"line"},null,-1)),U("div",{class:I(["node-box",{warning:R(n),action:R(i)}]),onClick:c},[U("div",Kt,[R(n)?(j(),C(a,{key:0,class:"icon",name:"warning"})):$("",!0),t[0]||(t[0]=U("span",{class:"text"},"Condition",-1))]),U("span",{class:"del-node",onClick:A(m,["stop"])},[_(a,{name:"flow-del"})]),U("div",Nt,[_(a,{size:"16",name:"flow-condition"})]),U("div",jt,[R(d)?(j(),z("span",Ct,D(R(d)),1)):$("",!0),U("span",null,D(R(u)),1)])],2),U("div",Et,[t[7]||(t[7]=U("div",{class:"line"},null,-1)),U("div",Ut,[U("div",zt,[t[2]||(t[2]=U("div",{class:"horizontal-line right"},null,-1)),t[3]||(t[3]=U("div",{class:"line"},null,-1)),U("div",St,[_(a,{name:"flow-success",size:"20"})]),U("div",Dt,[t[1]||(t[1]=U("div",{class:"line"},null,-1)),U("div",null,[_(Ze,{last:0===R(r).yes.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:f},null,8,["last","parent-type","parent-key"])])]),R(r).yes.length?(j(),z("ul",Rt,[(j(!0),z(h,null,S(R(r).yes,((e,t)=>(j(),z("li",{key:e.key},["condition"==e.type?(j(),C(l,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:g},null,8,["node-key"])):(j(),C(wt,{key:1,last:t===R(r).yes.length-1,type:e.type,"node-key":e.key,onAddNode:v,onSelectNode:p,onDelNormalNode:k},null,8,["last","type","node-key"]))])))),128))])):$("",!0)]),U("div",$t,[t[5]||(t[5]=U("div",{class:"horizontal-line left"},null,-1)),t[6]||(t[6]=U("div",{class:"line"},null,-1)),U("div",Pt,[_(a,{name:"flow-fail",size:"20"})]),U("div",At,[t[4]||(t[4]=U("div",{class:"line"},null,-1)),U("div",null,[_(Ze,{last:0===R(r).no.length,"parent-type":e.type,"parent-key":e.nodeKey,onAddNode:b},null,8,["last","parent-type","parent-key"])])]),R(r).no.length?(j(),z("ul",It,[(j(!0),z(h,null,S(R(r).no,((e,t)=>(j(),z("li",{key:e.key},["condition"==e.type?(j(),C(l,{key:0,type:"condition","node-key":e.key,onSelectNode:p,onDelCondition:g},null,8,["node-key"])):(j(),C(wt,{key:1,last:t===R(r).no.length-1,type:e.type,"node-key":e.key,onAddNode:y,onSelectNode:p,onDelNormalNode:x},null,8,["last","type","node-key"]))])))),128))])):$("",!0)])])])],64)}}}),Tt=i(Wt,[["__scopeId","data-v-fbf5dbc0"]]),Lt={class:"flow-container"},Gt={class:"flow-tree"},Vt=w({__name:"index",setup(e){async function t(e,t){const a=function(e,t){const a=Ue(e,"root");if(""===t)re.value.unshift({type:e,key:a.nodeKey});else{const l=re.value.findIndex((e=>e.key==t));re.value.splice(l+1,0,{type:e,key:a.nodeKey})}return a}(e,t.nodeKey);await qe("add"),n(a.type,a.nodeKey)}function a(e){Re(e)}function l(e,t){De(e,t),de.value===t&&n("trigger","root")}function n(e,t){se.value=Date.now(),ue.value=e,de.value=t}return(e,o)=>(j(),z("div",Lt,[U("ul",Gt,[U("li",null,[_(wt,{last:0===R(re).length,type:"trigger","node-key":"root",onSelectNode:n,onAddNode:t},null,8,["last"])]),(j(!0),z(h,null,S(R(re),((e,o)=>(j(),z("li",{key:e.key},["condition"==e.type?(j(),C(Tt,{key:0,type:"condition","node-key":e.key,onSelectNode:n,onDelCondition:a},null,8,["node-key"])):(j(),C(wt,{key:1,last:o===R(re).length-1,type:e.type,"node-key":e.key,onAddNode:t,onSelectNode:n,onDelNormalNode:l},null,8,["last","type","node-key"]))])))),128))])]))}}),Ot=i(Vt,[["__scopeId","data-v-459fbb31"]]),Ft={class:"p-20px"},qt=w({__name:"TriggerConfig",setup(e,{expose:t}){const a=K("formRef"),l=g({type:"subscriber_added",group_ids:[]}),n={group:{trigger:["change"],validator:()=>!!("subscriber_added"!==l.value.type&&"subscribed"!==l.value.type||l.value.group_ids.length)||new Error("Please select group")},link:{trigger:["input","blur"],validator:()=>!("clicked"===l.value.type&&!l.value.link.url)||new Error("Please enter link")}},o=g([{label:"When a new email joins group(s)",value:"subscriber_added"}]),i=g([]),r=e=>{switch(e){case"subscriber_added":case"subscribed":l.value={type:e,group_ids:[]};break;case"clicked":l.value={type:e,link:{url:""}};break;case"opened":case"unsubscribed":l.value={type:e}}};return(()=>{if((async()=>{i.value=ie.value.map((e=>({label:e.mail_type,value:e.id})))})(),de.value){const e=ce.value[de.value];e&&(l.value=M(e.config))}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=ce.value[de.value];e.config=M(l.value),e.complete=!0}}}),(e,t)=>{const s=X,d=J,u=Z,c=ee;return j(),z("div",Ft,[_(c,{ref_key:"formRef",ref:a,model:R(l),rules:n},{default:E((()=>[_(d,{label:"Trigger"},{default:E((()=>[_(s,{value:R(l).type,options:R(o),"onUpdate:value":r},null,8,["value","options"])])),_:1}),"subscriber_added"===R(l).type||"subscribed"===R(l).type?(j(),C(d,{key:0,label:"Group",path:"group"},{default:E((()=>[_(s,{value:R(l).group_ids,"onUpdate:value":t[0]||(t[0]=e=>R(l).group_ids=e),multiple:!0,filterable:!0,options:R(i)},null,8,["value","options"])])),_:1})):$("",!0),"clicked"===R(l).type?(j(),C(d,{key:1,label:"Link",path:"link"},{default:E((()=>[_(u,{value:R(l).link.url,"onUpdate:value":t[1]||(t[1]=e=>R(l).link.url=e)},null,8,["value"])])),_:1})):$("",!0)])),_:1},8,["model"])])}}}),Bt={class:"p-20px"},Ht=w({__name:"EmailConfig",setup(e,{expose:t}){const l=K("formRef"),n=T({name:"",subject:"",from_name:"",from:"",email_id:null,track_opens:!0,track_clicks:!0,track_unsubscribe:!0}),o=g([]),i={email_id:{trigger:["change"],validator:()=>!!n.email_id||new Error("Please select email template")},name:{trigger:["blur","input"],validator:()=>!!n.name||new Error("Please enter email name")},subject:{trigger:["blur","input"],validator:()=>!!n.subject||new Error("Please enter email subject")},from_name:{trigger:["blur","input"],validator:()=>!!n.from_name||new Error("Please enter sender name")},from:{trigger:["blur","input"],validator:()=>n.from?!!s(n.from)||new Error("Please enter a valid email address"):new Error("Please enter sender email")}},r=(e,t)=>{const{data:l}=t;a(l)&&(n.from_name=l.full_name)},u=async()=>{const{message:e}=await b();d(e)&&e.length>0&&(o.value=e.map((e=>({label:e.name,value:e.id}))))};return(()=>{if(u(),de.value){const e=pe.value[de.value];n.name=e.name,n.subject=e.subject,n.from_name=e.from_name,n.from=e.from,n.email_id=0===e.email_id?null:e.email_id,n.track_opens=e.track_opens,n.track_clicks=e.track_clicks,n.track_unsubscribe=e.track_unsubscribe}})(),t({submit:async()=>{if(await(l.value?.validate()),de.value){const e=pe.value[de.value];e.name=n.name,e.subject=n.subject,e.from_name=n.from_name,e.from=n.from,e.email_id=null===n.email_id?0:n.email_id,e.track_opens=n.track_opens,e.track_clicks=n.track_clicks,e.track_unsubscribe=n.track_unsubscribe,e.complete=!0}}}),(e,t)=>{const a=Z,s=J,d=X,u=te,c=ee;return j(),z("div",Bt,[_(c,{ref_key:"formRef",ref:l,model:R(n),rules:i},{default:E((()=>[_(s,{label:"Email name",path:"name"},{default:E((()=>[_(a,{value:R(n).name,"onUpdate:value":t[0]||(t[0]=e=>R(n).name=e),placeholder:"Name"},null,8,["value"])])),_:1}),_(s,{label:"Sender email",path:"from"},{default:E((()=>[_(ne,{value:R(n).from,"onUpdate:value":t[1]||(t[1]=e=>R(n).from=e),"is-init":!0,placeholder:"Sender email",onChange:r},null,8,["value"])])),_:1}),_(s,{label:"Who is it from?",path:"from_name"},{default:E((()=>[_(a,{value:R(n).from_name,"onUpdate:value":t[2]||(t[2]=e=>R(n).from_name=e),placeholder:"Sender name"},null,8,["value"])])),_:1}),_(s,{label:"Subject",path:"subject"},{default:E((()=>[_(a,{value:R(n).subject,"onUpdate:value":t[3]||(t[3]=e=>R(n).subject=e),placeholder:"Email subject"},null,8,["value"])])),_:1}),_(s,{label:"Template",path:"email_id"},{default:E((()=>[_(d,{value:R(n).email_id,"onUpdate:value":t[4]||(t[4]=e=>R(n).email_id=e),options:R(o)},null,8,["value","options"])])),_:1}),$("",!0),$("",!0),_(s,{label:"Whether to enable the unsubscribe link and collect unsubscribe statistics"},{default:E((()=>[_(u,{value:R(n).track_unsubscribe,"onUpdate:value":t[7]||(t[7]=e=>R(n).track_unsubscribe=e)},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),Mt={class:"p-20px"},Yt={class:"w-140px mr-12px"},Qt={class:"flex-1"},Xt=w({__name:"DelayConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({value:0,unit:"days"}),n=g([{label:"second(s)",value:"seconds"},{label:"minute(s)",value:"minutes"},{label:"hour(s)",value:"hours"},{label:"day(s)",value:"days"}]),o={value:{trigger:["blur","input"],validator:()=>l.value<=0?new Error("Value must be at least 1"):"days"===l.unit&&l.value>700?new Error("Value must be less than 700"):!!Number.isInteger(l.value)||new Error("Value must be an integer")}};return(()=>{if(de.value){const e=fe.value[de.value];l.value=e.value,l.unit=e.unit}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=fe.value[de.value];e.value=l.value,e.unit=l.unit,e.complete=!0}}}),(e,t)=>{const i=ae,r=X,s=J,d=ee;return j(),z("div",Mt,[_(d,{ref_key:"formRef",ref:a,model:R(l),rules:o},{default:E((()=>[_(s,{label:"Wait",path:"value"},{default:E((()=>[U("div",Yt,[_(i,{value:R(l).value,"onUpdate:value":t[0]||(t[0]=e=>R(l).value=e),min:0,"show-button":!1},null,8,["value"])]),U("div",Qt,[_(r,{value:R(l).unit,"onUpdate:value":t[1]||(t[1]=e=>R(l).unit=e),options:R(n)},null,8,["value","options"])])])),_:1})])),_:1},8,["model"])])}}}),Jt={class:"p-20px"},Zt=w({__name:"ActionConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({action:"add_to_subscribers",group_ids:[]}),n=g([{label:"添加到联系人列表中",value:"add_to_subscribers"},{label:"从联系人列表中删除",value:"remove_from_subscribers"},{label:"标记为已退订",value:"mark_as_unsubscribe"}]),o=g([]),i={group:{trigger:["change"],validator:()=>!!("add_to_subscribers"!==l.action&&"remove_from_subscribers"!==l.action||l.group_ids.length)||new Error("Please select group")}},r=()=>{l.group_ids=[]};return(()=>{if((async()=>{o.value=ie.value.map((e=>({label:e.mail_type,value:e.id})))})(),de.value){const e=be.value[de.value];l.action=e.action,l.group_ids=M(e.group_ids)}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=be.value[de.value];e.action=l.action,e.group_ids=M(l.group_ids),e.complete=!0}}}),(e,t)=>{const s=X,d=J,u=ee;return j(),z("div",Jt,[_(u,{ref_key:"formRef",ref:a,model:R(l),rules:i},{default:E((()=>[_(d,{label:"Choose an action"},{default:E((()=>[_(s,{value:R(l).action,"onUpdate:value":[t[0]||(t[0]=e=>R(l).action=e),r],options:R(n)},null,8,["value","options"])])),_:1}),L(_(d,{label:"Group",path:"group"},{default:E((()=>[_(s,{value:R(l).group_ids,"onUpdate:value":t[1]||(t[1]=e=>R(l).group_ids=e),multiple:!0,filterable:!0,options:R(o)},null,8,["value","options"])])),_:1},512),[[G,"add_to_subscribers"===R(l).action||"remove_from_subscribers"===R(l).action]])])),_:1},8,["model"])])}}}),ea={class:"p-20px"},ta=w({__name:"WebhookConfig",setup(e,{expose:t}){const a=K("formRef"),l=T({url:"",secret:""}),n={url:{required:!0,trigger:["blur","input"],message:"Please enter webhook URL"},secret:{required:!0,trigger:["blur","input"],message:"Please enter secret key"}};return(()=>{if(de.value){const e=ve.value[de.value];l.url=e.url,l.secret=e.secret}})(),t({submit:async()=>{if(await(a.value?.validate()),de.value){const e=ve.value[de.value];e.url=l.url,e.secret=l.secret,e.complete=!0}}}),(e,t)=>{const o=Z,i=J,r=ee;return j(),z("div",ea,[_(r,{ref_key:"formRef",ref:a,model:R(l),rules:n},{default:E((()=>[_(i,{label:"Webhook URL",path:"url"},{default:E((()=>[_(o,{value:R(l).url,"onUpdate:value":t[0]||(t[0]=e=>R(l).url=e),placeholder:""},null,8,["value"])])),_:1}),_(i,{label:"Secret Key",path:"secret"},{default:E((()=>[_(o,{value:R(l).secret,"onUpdate:value":t[1]||(t[1]=e=>R(l).secret=e),placeholder:""},null,8,["value"])])),_:1})])),_:1},8,["model"])])}}}),aa={class:"p-20px"},la={class:"flex-1"},na={class:"mt-12px"},oa={class:"mt-12px"},ia={class:"condition-box mt-12px"},ra={class:"flex justify-between items-center mb-16px"},sa=w({__name:"ConditionConfig",setup(e,{expose:t}){const l=K("formRef"),n=T({logic_type:"or",rules:[{type:null}]}),o=g([{label:"Campaign activity",value:"campaign"},{label:"Workflow activity",value:"workflow"}]),i=g([]),r=g([]),s=g([{label:"had any link clicked",value:"clicked"},{label:"had a specific link clicked",value:"link_clicked"},{label:"did not have a specific link clicked",value:"link_not_clicked"},{label:"was opened",value:"opened"},{label:"was not opened",value:"not_opened"},{label:"was opened with no links clicked",value:"opened_with_not_clicked"}]),c=e=>({trigger:"change",validator:()=>!!n.rules[e].type||new Error("Please select type")}),p=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!("campaign"===t.type&&!t.campaign.id)||new Error("Please select campaign")}}),f=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!!("workflow"!==t.type&&"campaign"!==t.type||t.action)||new Error("Please select action")}}),v=e=>({trigger:"change",validator:()=>{const t=n.rules[e];return!!("workflow"!==t.type&&"campaign"!==t.type||"link_clicked"!==t.action||t.link.url)||new Error("Please input link")}}),b=()=>{n.rules.push({type:null})};return(()=>{if((async()=>{const{message:e}=await y();d(e)&&(i.value=e.map((e=>({value:e.id,data:e,label:e.subject||e.task_name}))))})(),(()=>{const e=re.value.filter((e=>"email"===e.type)).map((e=>pe.value[e.key])).filter((e=>e.complete&&0!==e.id));r.value=e.map((e=>({label:e.name,value:e.id})))})(),de.value){const e=me.value[de.value];n.logic_type=e.logic_type,n.rules=M(e.rules)}})(),t({submit:async()=>{if(await(l.value?.validate()),de.value){const e=me.value[de.value];e.logic_type=n.logic_type,e.rules=M(n.rules),e.complete=!0}}}),(e,t)=>{const d=H,y=B,m=u,g=le,x=X,w=J,K=Z,N=ee;return j(),z("div",aa,[_(N,{ref_key:"formRef",ref:l,model:R(n)},{default:E((()=>[_(w,{label:"Create a condition"},{default:E((()=>[U("div",la,[t[6]||(t[6]=U("div",{class:"text-desc"}," Add up to 5 conditions. Define whether any or all of them must be applicable, for the condition to be met. ",-1)),_(y,{value:R(n).logic_type,"onUpdate:value":t[0]||(t[0]=e=>R(n).logic_type=e)},{default:E((()=>[U("div",na,[_(d,{value:"or"},{default:E((()=>t[1]||(t[1]=[U("div",null,"Any rule",-1),U("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ANY rule can match the criteria. ",-1)]))),_:1})]),U("div",oa,[_(d,{value:"and"},{default:E((()=>t[2]||(t[2]=[U("div",null,"All rules",-1),U("div",{class:"mt-8px text-desc"}," Select one or a few conditions where ALL rules must match the criteria. ",-1)]))),_:1})])])),_:1},8,["value"]),(j(!0),z(h,null,S(R(n).rules,((e,l)=>(j(),z(h,{key:l},[0!==l?(j(),C(m,{key:0,class:"mt-12px!","title-placement":"left"},{default:E((()=>[k(D(R(n).logic_type),1)])),_:1})):$("",!0),U("div",ia,[U("div",ra,[t[4]||(t[4]=U("span",null,"Condition",-1)),R(n).rules.length>1?(j(),C(g,{key:0,size:"small",onClick:e=>(e=>{n.rules.splice(e,1)})(l)},{default:E((()=>t[3]||(t[3]=[k("Delete")]))),_:2},1032,["onClick"])):$("",!0)]),_(w,{"show-label":!1,path:`rules[${l}].type`,rule:c(l)},{default:E((()=>[_(x,{value:e.type,options:R(o),"onUpdate:value":e=>((e,t)=>{switch(e){case"campaign":n.rules[t]={type:"campaign",action:null,campaign:{id:null,name:""},link:{url:""}};break;case"workflow":n.rules[t]={type:"workflow",node_id:null,action:null,link:{url:""}}}})(e,l)},null,8,["value","options","onUpdate:value"])])),_:2},1032,["path","rule"]),"campaign"===e.type?(j(),C(w,{key:0,"show-label":!1,path:`rules[${l}].campaign.id`,rule:p(l)},{default:E((()=>[_(x,{value:e.campaign.id,"onUpdate:value":[t=>e.campaign.id=t,(e,t)=>((e,t)=>{a(t.data)&&"campaign"===n.rules[e].type&&(n.rules[e].campaign.name=t.data.subject)})(l,t)],options:R(i)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"])):$("",!0),"workflow"===e.type?(j(),C(w,{key:1,"show-label":!1,path:`rules[${l}].workflow.node_id`},{default:E((()=>[_(x,{value:e.node_id,"onUpdate:value":t=>e.node_id=t,options:R(r)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path"])):$("",!0),"campaign"===e.type&&e.campaign.id||"workflow"===e.type&&e.node_id?(j(),z(h,{key:2},[_(w,{"show-label":!1,path:`rules[${l}].action`,rule:f(l)},{default:E((()=>[_(x,{value:e.action,"onUpdate:value":t=>e.action=t,options:R(s)},null,8,["value","onUpdate:value","options"])])),_:2},1032,["path","rule"]),L(_(w,{"show-label":!1,path:`rules[${l}].link.url`,rule:v(l)},{default:E((()=>[_(K,{value:e.link.url,"onUpdate:value":t=>e.link.url=t,placeholder:"Please input link"},null,8,["value","onUpdate:value"])])),_:2},1032,["path","rule"]),[[G,"link_clicked"===e.action]])],64)):$("",!0)])],64)))),128)),_(g,{class:"mt-12px",size:"small",onClick:b},{default:E((()=>t[5]||(t[5]=[k(" Add another condition ")]))),_:1})])])),_:1})])),_:1},8,["model"])])}}}),da=i(sa,[["__scopeId","data-v-c8dfd4ad"]]),ua=i({},[["render",function(e,t){return j(),z("div")}]]),ca={class:"flow-config"},pa={class:"config-title"},fa={class:"text-14px font-bold"},va={class:"flex-1 overflow-auto"},ba={class:"config-footer"},ya=i(w({__name:"index",setup(e){const t=g(),a=N((()=>{switch(ue.value){case"trigger":return qt;case"email":return Ht;case"action":return Zt;case"delay":return Xt;case"webhook":return ta;case"condition":return da;default:return ua}})),l=N((()=>{const e=ue.value;return e?r(e):""})),n=async()=>{await(t.value?.submit?.()),qe()};return(e,o)=>{const i=le;return j(),z("div",ca,[U("div",pa,[U("span",fa,D(R(l)),1)]),U("div",va,[(j(),C(P(R(a)),{ref_key:"compRef",ref:t,key:R(se)}))]),U("div",ba,[_(i,{class:"font-bold",size:"large",type:"primary",onClick:n},{default:E((()=>o[0]||(o[0]=[k("Save")]))),_:1})])])}}}),[["__scopeId","data-v-b1d9958a"]]),ma={class:"mail-flow"},ga={class:"relative flex flex-1 overflow-auto"},_a={class:"absolute top-16px left-24px z-1000"},ka=w({__name:"index",setup(e){const t=V();t.params.id&&(oe.value=c(t.params.id));const a=O(),l=async()=>{try{await qe()}finally{setTimeout((()=>{a.go(-1)}),1e3)}},n=async()=>{const{message:e}=await m();ie.value=d(e)?e:[]},o=g(!1);return(async()=>{try{o.value=!0,await Promise.all([n(),Fe()]),He()}finally{o.value=!1}})(),F((()=>{He(),Be()})),(e,t)=>{const a=le,n=p;return j(),C(n,{class:"w-full h-full",show:R(o)},{default:E((()=>[U("div",ma,[U("div",ga,[U("div",_a,[_(a,{size:"large",class:"font-bold",secondary:"",onClick:l},{default:E((()=>t[0]||(t[0]=[k("Save and back")]))),_:1})]),_(Ot),_(ya)])])])),_:1},8,["show"])}}});e("default",i(ka,[["__scopeId","data-v-b7d1832f"]]))}}}));
