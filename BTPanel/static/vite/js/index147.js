import{am as e,n as a,bc as t,eH as s,_ as l,m as n,p as o}from"./page_layout.js?v=1758789124250";import{k as i,P as r,r as p,c as d,W as c,j as u,R as f,V as m,S as g,a3 as h,a4 as _,U as b,ak as w,a2 as x,au as C,an as v}from"./vue.js?v=1758789124250";import{f as y}from"./public.js?v=1758789124250";import{c as U}from"./file.js?v=1758789124250";import{bH as z,aC as F,dg as k}from"./naive.js?v=1758789124250";import"./common.js?v=1758789124250";import"./__commonjsHelpers__.js?v=1758789124250";const j={class:"p-16px"},M={class:"flex items-center mb-12px"},S={key:1,class:"flex-center flex-col h-300px"},B={class:"drag-text"},D={key:0,class:"drag-suffix"},E=o(i({__name:"index",props:{path:{default:""},size:{},uploadData:{default:()=>({multiple:!1})},uploadSuccess:{},showSuccessMsg:{type:Boolean,default:!0}},emits:["setConfirm"],setup(o,{expose:i,emit:E}){const P=o,H=E,{path:$,uploadData:L}=P,{t:A}=r(),I=e(),N=p([]),R=p(new Map),T=d(()=>(L.accept||"").split(",").map(e=>"'".concat(e,"'")).join(", ")),V=e=>{var a,t,s;const{file:l}=e;return(null!=(t=null==(a=l.file)?void 0:a.size)?t:0)>1048576*(null!=(s=P.size)?s:1/0)?(n.error(A("Component.UploadFile.index_7",[l.name,P.size])),!1):(L.multiple||(N.value=[]),!0)},W=p([{key:"name",title:A("Component.UploadFile.index_3"),ellipsis:!0},{key:"size",title:A("Component.UploadFile.index_4"),width:100,render:e=>{var t;return a(null==(t=e.file)?void 0:t.size)}},{key:"status",title:A("Component.UploadFile.index_5"),width:140,render:e=>{if("pending"===e.status)return A("Component.UploadFile.index_8");if("finished"===e.status)return c("span",{class:"text-primary"},[A("Component.UploadFile.index_9")]);if("error"===e.status)return c("span",{class:"text-error"},[u("Upload Failed")]);const a=e.percentage?e.percentage.toFixed(1):0;return c(z,{type:"line",color:I.value.primaryColor,"indicator-placement":"outside",processing:!0,percentage:Number(a)},null)}},y({width:70,options:(e,a)=>[{label:A("Public.Btn.Del"),type:"error",show:"uploading"!==e.status,onClick:()=>N.value.splice(a,1)},{label:A("Public.Btn.Cancel"),type:"warning",show:"uploading"===e.status,onClick:()=>(e=>{const a=e.id||e.name,t=R.value.get(a);t&&(t.abort(),R.value.delete(a),e.status="error",e.percentage=0,n.info("Upload Canceled: ".concat(e.name)))})(e)}]})]),q=async(e,a,t,s)=>{const l=10485760,n=Math.ceil(e.size/l);let o=0;for(let p=0;p<n;p++){if(s.signal.aborted)throw new Error("Upload Canceled");const n=o,d=Math.min(e.size,n+l),c=e.slice(n,d),u=d-n,f=new FormData;f.append("f_path",$),f.append("f_name",a),f.append("f_size",e.size.toString()),f.append("f_start",n.toString()),f.append("blob",c);try{const a=await U(f,a=>{if(s.signal.aborted)return;const l=(o+(a.progress||0)*u)/e.size*100;t(Math.min(l,99))});let n=d;if(a&&"number"==typeof a.message&&(n=a.message),o=Math.max(o,n),t(Math.min(o/e.size*100,99)),o>=e.size)break;p=Math.floor(o/l)-1}catch(i){let e=!1;for(let a=0;a<3;a++){if(s.signal.aborted)throw new Error("Upload Canceled");try{await new Promise(e=>setTimeout(e,1e3));const a=await U(f);if(a&&"number"==typeof a.message){o=a.message,e=!0;break}}catch(r){e=!1}}if(!e)throw new Error("Chunk ".concat(p+1," upload failed"))}}return t(100),!0};return i({onConfirm:async()=>{var e;const a=N.value.filter(e=>"pending"===e.status);if(!a.length)return n.error(A("Component.UploadFile.index_10")),!1;H("setConfirm",{disabled:!0}),a.forEach(e=>e.status="uploading");let t=!0,s=!1;for(const i of a){const e=i.file;if(!e)continue;const a=new AbortController,l=i.id||i.name;R.value.set(l,a);try{if(e.size>52428800){if(!(await q(e,i.name,e=>i.percentage=e,a))||a.signal.aborted){i.status="error",s=!0;continue}}else{const t=new FormData;t.append("f_path",$),t.append("f_name",i.name),t.append("f_start","0"),t.append("f_size",e.size.toString()),t.append("blob",e),await U(t,e=>{a.signal.aborted||(i.percentage=100*(e.progress||0))})}if(a.signal.aborted){i.status="error",s=!0;continue}i.status="finished"}catch(o){i.status="error",n.error("".concat(i.name," upload failed}")),t=!1}finally{R.value.delete(l)}}if(t&&!s&&P.showSuccessMsg){a.filter(e=>"finished"===e.status).length&&n.success(A("Component.UploadFile.index_9"))}H("setConfirm",{disabled:!1});const l=a.filter(e=>"finished"===e.status);return l.length&&await(null==(e=P.uploadSuccess)?void 0:e.call(P,l)),t&&!s}}),(e,a)=>{const n=F,o=t,i=k,r=l,p=s;return m(),f("div",j,[g("div",M,[c(o,{ref:"upload",class:"w-auto","file-list":b(N),"onUpdate:fileList":a[0]||(a[0]=e=>w(N)?N.value=e:null),accept:b(L).accept,multiple:b(L).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:h(()=>[c(n,{type:"primary"},{default:h(()=>[u(_(e.$t("Component.UploadFile.index_6")),1)]),_:1})]),_:1},8,["file-list","accept","multiple"])]),c(o,{ref:"upload",class:"w-auto","file-list":b(N),"onUpdate:fileList":a[2]||(a[2]=e=>w(N)?N.value=e:null),accept:b(L).accept,multiple:b(L).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:h(()=>[c(p,null,{default:h(()=>[b(N).length>0?(m(),x(i,{key:0,"max-height":300,bordered:!1,data:b(N),columns:b(W),onClick:a[1]||(a[1]=C(()=>{},["stop"]))},null,8,["data","columns"])):(m(),f("div",S,[c(r,{name:"base-upload",size:"48",class:"text-#999"}),g("div",B,_(e.$t("Component.UploadFile.index_1")),1),b(L).accept?(m(),f("div",D,_(e.$t("Component.UploadFile.index_2",[b(T)])),1)):v("",!0)]))]),_:1})]),_:1},8,["file-list","accept","multiple"])])}}}),[["__scopeId","data-v-fd46742b"]]);export{E as default};
