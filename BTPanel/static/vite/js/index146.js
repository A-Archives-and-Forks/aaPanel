import{ab as e,n as a,m as t,cl as s,_ as l,dQ as n,e as o}from"./page_layout.js?v=1753954525509";import{k as i,P as r,r as p,c as d,Q as c,j as u,U as f,V as m,W as h,a2 as g,a3 as _,X as b,ah as w,a1 as x,au as C,al as v}from"./vue.js?v=1753954525509";import{h as y}from"./public.js?v=1753954525509";import{b as U}from"./file2.js?v=1753954525509";import{bA as z,ay as F,c2 as k}from"./naive.js?v=1753954525509";import"./common.js?v=1753954525509";import"./__commonjsHelpers__.js?v=1753954525509";const j={class:"p-16px"},M={class:"flex items-center mb-12px"},S={key:1,class:"flex-center flex-col h-300px"},B={class:"drag-text"},D={key:0,class:"drag-suffix"},E=o(i({__name:"index",props:{path:{default:""},size:{default:100},uploadData:{default:()=>({multiple:!1})},uploadSuccess:{},showSuccessMsg:{type:Boolean,default:!0}},emits:["setConfirm"],setup(o,{expose:i,emit:E}){const P=o,$=E,{path:A,uploadData:L}=P,{t:Q}=r(),H=e(),I=p([]),N=p(new Map),T=d((()=>(L.accept||"").split(",").map((e=>"'".concat(e,"'"))).join(", "))),V=e=>{var a,s;const{file:l}=e;return(null!=(s=null==(a=l.file)?void 0:a.size)?s:0)>1048576*P.size?(t.error(Q("Component.UploadFile.index_7",[l.name,P.size])),!1):(L.multiple||(I.value=[]),!0)},W=p([{key:"name",title:Q("Component.UploadFile.index_3"),ellipsis:!0},{key:"size",title:Q("Component.UploadFile.index_4"),width:100,render:e=>{var t;return a(null==(t=e.file)?void 0:t.size)}},{key:"status",title:Q("Component.UploadFile.index_5"),width:140,render:e=>{if("pending"===e.status)return Q("Component.UploadFile.index_8");if("finished"===e.status)return c("span",{class:"text-primary"},[Q("Component.UploadFile.index_9")]);if("error"===e.status)return c("span",{class:"text-error"},[u("Upload Failed")]);const a=e.percentage?e.percentage.toFixed(1):0;return c(z,{type:"line",color:H.value.primaryColor,"indicator-placement":"outside",processing:!0,percentage:Number(a)},null)}},y({width:70,options:(e,a)=>[{label:Q("Public.Btn.Del"),type:"error",show:"uploading"!==e.status,onClick:()=>I.value.splice(a,1)},{label:Q("Public.Btn.Cancel"),type:"warning",show:"uploading"===e.status,onClick:()=>(e=>{const a=e.id||e.name,s=N.value.get(a);s&&(s.abort(),N.value.delete(a),e.status="error",e.percentage=0,t.info("Upload Canceled: ".concat(e.name)))})(e)}]})]),X=async(e,a,t,s)=>{const l=10485760,n=Math.ceil(e.size/l);let o=0;for(let p=0;p<n;p++){if(s.signal.aborted)throw new Error("Upload Canceled");const n=o,d=Math.min(e.size,n+l),c=e.slice(n,d),u=d-n,f=new FormData;f.append("f_path",A),f.append("f_name",a),f.append("f_size",e.size.toString()),f.append("f_start",n.toString()),f.append("blob",c);try{const a=await U(f,(a=>{if(s.signal.aborted)return;const l=(o+(a.progress||0)*u)/e.size*100;t(Math.min(l,99))}));let n=d;if(a&&"number"==typeof a.message&&(n=a.message),o=Math.max(o,n),t(Math.min(o/e.size*100,99)),o>=e.size)break;p=Math.floor(o/l)-1}catch(i){let e=!1;for(let a=0;a<3;a++){if(s.signal.aborted)throw new Error("Upload Canceled");try{await new Promise((e=>setTimeout(e,1e3)));const a=await U(f);if(a&&"number"==typeof a.message){o=a.message,e=!0;break}}catch(r){e=!1}}if(!e)throw new Error("Chunk ".concat(p+1," upload failed"))}}return t(100),!0};return i({onConfirm:async()=>{var e;const a=I.value.filter((e=>"pending"===e.status));if(!a.length)return t.error(Q("Component.UploadFile.index_10")),!1;$("setConfirm",{disabled:!0}),a.forEach((e=>e.status="uploading"));let s=!0,l=!1;for(const i of a){const e=i.file;if(!e)continue;const a=new AbortController,n=i.id||i.name;N.value.set(n,a);try{if(e.size>52428800){if(!(await X(e,i.name,(e=>i.percentage=e),a))||a.signal.aborted){i.status="error",l=!0;continue}}else{const t=new FormData;t.append("f_path",A),t.append("f_name",i.name),t.append("f_start","0"),t.append("f_size",e.size.toString()),t.append("blob",e),await U(t,(e=>{a.signal.aborted||(i.percentage=100*(e.progress||0))}))}if(a.signal.aborted){i.status="error",l=!0;continue}i.status="finished"}catch(o){i.status="error",t.error("".concat(i.name," upload failed}")),s=!1}finally{N.value.delete(n)}}if(s&&!l&&P.showSuccessMsg){a.filter((e=>"finished"===e.status)).length&&t.success(Q("Component.UploadFile.index_9"))}$("setConfirm",{disabled:!1});const n=a.filter((e=>"finished"===e.status));return n.length&&await(null==(e=P.uploadSuccess)?void 0:e.call(P,n)),s&&!l}}),(e,a)=>{const t=F,o=s,i=k,r=l,p=n;return f(),m("div",j,[h("div",M,[c(o,{ref:"upload",class:"w-auto","file-list":b(I),"onUpdate:fileList":a[0]||(a[0]=e=>w(I)?I.value=e:null),accept:b(L).accept,multiple:b(L).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:g((()=>[c(t,{type:"primary"},{default:g((()=>[u(_(e.$t("Component.UploadFile.index_6")),1)])),_:1})])),_:1},8,["file-list","accept","multiple"])]),c(o,{ref:"upload",class:"w-auto","file-list":b(I),"onUpdate:fileList":a[2]||(a[2]=e=>w(I)?I.value=e:null),accept:b(L).accept,multiple:b(L).multiple,"default-upload":!1,"show-file-list":!1,onBeforeUpload:V},{default:g((()=>[c(p,null,{default:g((()=>[b(I).length>0?(f(),x(i,{key:0,"max-height":300,bordered:!1,data:b(I),columns:b(W),onClick:a[1]||(a[1]=C((()=>{}),["stop"]))},null,8,["data","columns"])):(f(),m("div",S,[c(r,{name:"base-upload",size:"48",class:"text-#999"}),h("div",B,_(e.$t("Component.UploadFile.index_1")),1),b(L).accept?(f(),m("div",D,_(e.$t("Component.UploadFile.index_2",[b(T)])),1)):v("",!0)]))])),_:1})])),_:1},8,["file-list","accept","multiple"])])}}}),[["__scopeId","data-v-86c45828"]]);export{E as default};
